# **大疆司空 2 二次开发概览**

本文档基于《大疆司空 2 使用说明》整理了可用于二次开发的主要组件、接口（API）及其使用方法。请注意，部分功能仅限于私有化部署版本。

## **1\. OpenAPI**

OpenAPI 是基于 RESTful 规范设计的开放平台，允许第三方云平台与司空 2（公有云和私有版均支持，但部分接口或认证方式可能不同）进行深度交互。

* **主要功能**:  
  * **认证与鉴权**: 通过 X-User-Token (需参考认证鉴权教程获取) 和 X-Project-Uuid 保证接口安全。  
  * **组织与项目管理**: 获取组织下的项目列表 (/openapi/v0.1/project)、获取项目下的设备列表 (/openapi/v0.1/project/device)、获取项目存储上传凭证 (/openapi/v0.1/project/sts-token)、添加人员到项目 (/openapi/v0.1/project/member)。  
  * **设备管理**: 获取组织下的设备列表 (/openapi/v0.1/device)、获取设备信息、相机和镜头信息、获取设备控制权、切换镜头等（具体接口需查阅完整 OpenAPI 文档）。  
  * **直播管理**: 开启/关闭直播推流、获取直播链接。  
  * **航线管理**: 上传、下载、管理航线文件。  
  * **任务管理**: 创建、下发、查询飞行任务状态和轨迹。  
  * **模型管理**: 管理二维/三维模型。  
  * **标注管理**: 管理地图标注。  
* **使用方法**:  
  * 通过标准的 HTTP 请求（GET, POST, PUT, DELETE）调用接口。  
  * 请求 Header 中通常需要包含 X-User-Token 和 X-Project-Uuid 等认证信息。  
  * 具体接口路径、参数和返回值请参考完整的 **OpenAPI 接口文档**（PDF P373 提及）。  
* **适用版本**: 公有云 & 私有版

## **2\. 前端组件 (仅限私有版)**

允许将司空 2 的核心用户界面 (UI) 模块嵌入到您自己的 Web 应用中。

* **可用组件**:  
  * **航线创建** (loadWaylineCreation)  
  * **航线编辑器** (loadWayline)  
  * **驾驶舱/虚拟座舱** (loadCockpit)  
  * **项目/地图** (loadProject)  
* **使用方法** (参考 Demo 文件和 PDF P374-P386):  
  1. 引入 paas.js: 在 HTML 中引入私有部署提供的核心 JS 文件。  
     \<script src="http://【私有部署 IP 或域名】/paas.js" fh2\>\</script\>  
  2. **准备 HTML 容器**: 定义具有特定 id 的 \<div\> 元素。  
  3. **初始化配置 (initConfig)**: **必须**在加载组件前调用，传入服务器地址、项目 ID (prjId) 和组织密钥 (projectToken)。  
     window.FH2.initConfig({  
         serverUrl: \`http://{IP}:30812\`,  
         wssUrl: \`ws://{IP}:30812/duplex/web\`,  
         hostUrl: \`http://{IP}\`,  
         prjId: 'YOUR\_PROJECT\_ID',  
         projectToken: 'YOUR\_ORGANIZATION\_KEY'  
     });

  4. **加载组件 (load\[ComponentName\])**: 调用相应函数加载组件到指定容器，并传入必要参数（如航线 ID、设备 SN）。  
     // 示例：加载航线编辑器  
     window.FH2.loadWayline("wayline-app-container", { wayline\_id: 'YOUR\_WAYLINE\_ID' });  
     // 示例：加载驾驶舱  
     window.FH2.loadCockpit("cockpit-app-container", { gateway\_sn: 'YOUR\_GATEWAY\_SN', drone\_sn: 'YOUR\_DRONE\_SN' });

  5. **(可选) 事件订阅 (subscribe)**: 监听组件内部事件。  
  6. **(可选) 地图定制 (cesiumViewer)**: 获取 Cesium 实例进行高级定制。  
* **适用版本**: 私有版

## **3\. MQTT 桥接 (仅限私有版)**

提供将机场设备的实时遥测数据（如位置、姿态等）通过 MQTT 协议转发到第三方系统的能力。

* **主要功能**:  
  * 将司空 2 内部的 MQTT 消息实时桥接转发到用户自己的 MQTT Broker。  
  * 推送设备上下线状态通知 (通过 Webhook)。  
* **使用方法** (参考 PDF P387-P391):  
  1. **配置桥接**: 使用 curl 命令向司空 2 的特定接口 (如 http://{IP}:38080/bridges/v1/resources) 发送 POST 请求，配置第三方 MQTT Broker 地址、认证信息、Webhook URL 等。  
  2. **管理桥接**: 提供查询、修改、开关桥接状态的 curl 命令。  
  3. **设备绑定**: 机场设备需同时绑定到第三方系统（获取 MQTT Topic 信息）和司空 2 私有版。  
  4. **数据订阅**: 在第三方 MQTT Broker 上订阅相应的 Topic (如 thing/product/+/osd) 来接收数据。  
* **注意事项**:  
  * 需要确保司空 2 服务器与第三方 MQTT Broker 网络互通。  
  * 直播功能与 MQTT 桥接同时使用时，第三方系统优先级更高。  
  * 开启桥接后，媒体文件会直接转发到第三方系统，需配置存储桶（参考媒体管理教程）。  
* **适用版本**: 私有版

## **4\. 司空 Sync (原云端互联升级版)**

支持将司空 2（公有云和私有版均支持）的数据同步至第三方云平台。

* **主要功能** (参考 PDF P357, P392-P397):  
  * **文件同步**: 将媒体文件、航线、模型、飞行记录同步到第三方存储桶 (AWS S3, 阿里云 OSS, 自托管 S3)。  
    * 司空 \-\> 第三方: 实时触发。  
    * 第三方 \-\> 司空 (仅航线、模型): 定期扫描。  
  * **直播转发**: 支持 RTMP (公/私) 和 GB28181 (仅私有) 协议，将直播流推送到第三方平台。  
  * **设备信息同步**: 公有版通过遥测数据接口实现，私有版通过 MQTT Bridge 实现。  
  * **第三方 OAuth (仅私有版)**: 支持通过第三方系统的 Token 访问司空。  
* **使用方法**:  
  * 在司空 2 组织设置 \-\> 司空 Sync (或云端互联) 界面进行配置。  
  * 配置存储桶参数 (Access Key, Secret Key, Endpoint, Bucket Name 等)。  
  * 配置需要同步的项目和文件类型。  
  * 配置直播转发通道 (服务器地址、码流源等)。  
* **适用版本**: 公有云 & 私有版 (部分功能如 MQTT Bridge, OAuth 仅私有版)

## **5\. Webhook (常与司空 Sync/云端互联配合)**

用于司空 2 向第三方平台推送实时事件通知。

* **主要功能** (参考 PDF P357, P367):  
  * **新文件生成通知**: 当模型重建完成或新航线生成时，通过 Webhook URL 推送包含文件 ID 的通知。第三方可通过文件 ID 调用 API 获取下载链接。  
  * **设备上下线通知**: (用于 MQTT 桥接) 设备连接或断开时通过 Webhook 通知。  
  * **告警通知**: (用于 AI 航线) 识别到目标后，可配置通过 Webhook 推送告警信息。  
* **使用方法**:  
  * 在司空 2 组织设置 \-\> 司空 Sync (或云端互联) 中配置接收通知的 Webhook URL。  
  * 第三方系统需要部署一个能接收并处理这些 HTTP POST 请求的服务端点。  
* **适用版本**: 公有云 & 私有版

**总结**:

* **公有云用户**: 主要依赖 **OpenAPI** 进行后端集成，利用 **司空 Sync** 进行数据同步和直播流转发。需要自建前端 UI。  
* **私有版用户**: 除了拥有公有云的所有开发能力外，还可以使用 **前端组件** 快速嵌入 UI 模块，并通过 **MQTT 桥接** 获取更实时的设备数据。

请根据您的具体部署版本和需求，选择合适的二次开发方式，并参考大疆官方提供的详细接口文档进行开发。