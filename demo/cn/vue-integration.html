<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue集成 司空2 前端组件示例</title>
    <!-- 引入Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入Tailwind CSS用于快速样式开发 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 paas.js -->
    <script src="http://127.0.0.1/paas.js" fh2></script>
    <!-- 引入自定义样式 -->
    <link href="./custom-style.css" rel="stylesheet">
    
    <style>
        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .fh2-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        .component-wrapper {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* 确保组件内部容器正确显示 */
        #project-app-container > div, #cockpit-app-container > div,
        #wayline-app-container > div, #wayline-create-app-container > div,
        .map-app-container > div {
            height: 100% !important;
            width: 100% !important;
        }
    </style>
</head>
<body class="p-4">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Vue集成 司空2 前端组件示例</h1>
            <p class="text-gray-600 mt-2">本示例演示如何在Vue项目中集成大疆司空2前端组件</p>
        </header>
        
        <!-- 连接配置面板 -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">连接配置</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="serverIp" class="block text-sm font-medium text-gray-700 mb-1">服务IP:</label>
                    <input type="text" id="serverIp" v-model="serverConfig.ip" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="127.0.0.1">
                </div>
                <div>
                    <label for="projectId" class="block text-sm font-medium text-gray-700 mb-1">项目ID:</label>
                    <input type="text" id="projectId" v-model="serverConfig.projectId" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="输入项目ID">
                </div>
                <div>
                    <label for="projectToken" class="block text-sm font-medium text-gray-700 mb-1">组织密钥:</label>
                    <input type="text" id="projectToken" v-model="serverConfig.token" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="输入组织密钥">
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <button @click="initSystem" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors" :disabled="isInitialized">
                    {{ isInitialized ? '已初始化' : '初始化系统' }}
                </button>
                <button @click="loadAllComponents" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors" :disabled="!isInitialized">
                    加载所有组件
                </button>
                <button @click="destroyAllComponents" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                    销毁所有组件
                </button>
                <button @click="toggleTheme" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                    {{ isDarkTheme ? '切换到浅色主题' : '切换到深色主题' }}
                </button>
                <button @click="addCustomMapData" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700 transition-colors" :disabled="!isInitialized">
                    添加地图自定义元素
                </button>
            </div>
        </div>
        
        <!-- 状态信息 -->
        <div class="bg-gray-100 p-3 rounded-md mb-6" v-if="statusMessage">
            <p :class="['text-sm', statusError ? 'text-red-600' : 'text-green-600']">
                {{ statusMessage }}
            </p>
        </div>
        
        <!-- 组件展示区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 项目地图组件 -->
            <div>
                <h3 class="text-lg font-medium mb-2">项目地图组件</h3>
                <div class="component-wrapper">
                    <div class="fh2-container">
                        <div class="project-details">
                            <div id="project-app-container"></div>
                            <div id="project-middle-container"></div>
                            <div id="project-right-micro-app" class="right-micro-app">
                                <div class="maps-micro-app">
                                    <div id="project-map-app-placeholder" class="map-app-placeholder">
                                        <div id="map-app-global" class="map-app-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button @click="loadProjectComponent" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                        单独加载项目地图
                    </button>
                    <button @click="destroyProjectComponent" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors ml-2">
                        销毁项目地图
                    </button>
                </div>
            </div>
            
            <!-- 驾驶舱组件 -->
            <div>
                <h3 class="text-lg font-medium mb-2">驾驶舱组件</h3>
                <div class="component-wrapper">
                    <div class="fh2-container">
                        <div id="cockpit-header-container"></div>
                        <div class="project-details router-cockpit">
                            <div id="project-app-container-cockpit"></div>
                            <div id="project-middle-container-cockpit"></div>
                            <div id="project-right-micro-app-cockpit" class="right-micro-app">
                                <div class="maps-micro-app">
                                    <div class="cockpit-left-border-container"></div>
                                    <div id="project-map-app-placeholder-cockpit" class="map-app-placeholder">
                                        <div class="cockpit-dock-live-container"></div>
                                        <div id="map-app-global-cockpit" class="map-app-container"></div>
                                        <div class="cockpit-bottom-border-container"></div>
                                    </div>
                                </div>
                                <div class="project-right">
                                    <div id="cockpit-app-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" v-model="componentConfig.gatewaySn" placeholder="网关SN" 
                        class="text-sm px-2 py-1 border border-gray-300 rounded mr-2">
                    <input type="text" v-model="componentConfig.droneSn" placeholder="飞行器SN" 
                        class="text-sm px-2 py-1 border border-gray-300 rounded mr-2">
                    <button @click="loadCockpitComponent" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                        加载驾驶舱
                    </button>
                    <button @click="destroyCockpitComponent" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors ml-2">
                        销毁驾驶舱
                    </button>
                </div>
            </div>
            
            <!-- 航线编辑器组件 -->
            <div>
                <h3 class="text-lg font-medium mb-2">航线编辑器组件</h3>
                <div class="component-wrapper">
                    <div class="fh2-container">
                        <div id="wayline-header"></div>
                        <div class="project-details">
                            <div id="project-app-container-wayline"></div>
                            <div id="project-middle-container-wayline"></div>
                            <div id="project-right-micro-app-wayline" class="right-micro-app">
                                <div class="maps-micro-app">
                                    <div id="project-map-app-placeholder-wayline" class="map-app-placeholder">
                                        <div id="map-app-global-wayline" class="map-app-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <input type="text" v-model="componentConfig.waylineId" placeholder="航线ID" 
                        class="text-sm px-2 py-1 border border-gray-300 rounded mr-2">
                    <button @click="loadWaylineComponent" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                        加载航线编辑器
                    </button>
                    <button @click="destroyWaylineComponent" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors ml-2">
                        销毁航线编辑器
                    </button>
                </div>
            </div>
            
            <!-- 航线创建组件 -->
            <div>
                <h3 class="text-lg font-medium mb-2">航线创建组件</h3>
                <div class="component-wrapper">
                    <div class="fh2-container">
                        <div id="wayline-create-header-container"></div>
                        <div class="project-details">
                            <div id="project-app-container-wayline-create"></div>
                            <div id="project-middle-container-wayline-create"></div>
                            <div id="project-right-micro-app-wayline-create" class="right-micro-app">
                                <div class="maps-micro-app">
                                    <div id="project-map-app-placeholder-wayline-create" class="map-app-placeholder">
                                        <div id="map-app-global-wayline-create" class="map-app-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <button @click="loadWaylineCreationComponent" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                        加载航线创建
                    </button>
                    <button @click="destroyWaylineCreationComponent" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors ml-2">
                        销毁航线创建
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Vue集成说明 -->
        <div class="mt-12 bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Vue集成说明</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-medium text-gray-800">1. 组件封装方式</h3>
                    <p class="text-gray-700">在实际Vue项目中，推荐将每个FH2组件封装为单独的Vue组件，以下是封装示例：</p>
                    <pre class="bg-gray-100 p-3 rounded-md overflow-x-auto mt-2"><code>// ProjectMap.vue 示例
&lt;template&gt;
  &lt;div class="project-map-container"&gt;
    &lt;div class="fh2-container"&gt;
      &lt;div class="project-details"&gt;
        &lt;div id="project-app-container"&gt;&lt;/div&gt;
        &lt;div id="project-middle-container"&gt;&lt;/div&gt;
        &lt;div id="project-right-micro-app" class="right-micro-app"&gt;
          &lt;div class="maps-micro-app"&gt;
            &lt;div id="project-map-app-placeholder" class="map-app-placeholder"&gt;
              &lt;div id="map-app-global" class="map-app-container"&gt;&lt;/div&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'ProjectMap',
  mounted() {
    // 确保FH2 SDK已加载
    if (window.FH2) {
      window.FH2.loadProject("project-app-container");
    }
  },
  beforeUnmount() {
    // 组件销毁时释放资源
    if (window.FH2) {
      window.FH2.destroyProject();
    }
  }
}
&lt;/script&gt;</code></pre>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-800">2. 在Vue项目中的集成步骤</h3>
                    <ol class="list-decimal list-inside text-gray-700 space-y-2">
                        <li>在项目的入口HTML文件中引入paas.js：<code>&lt;script src="http://your-server-ip/paas.js" fh2&gt;&lt;/script&gt;</code></li>
                        <li>创建SDK初始化服务，统一管理FH2的初始化和配置</li>
                        <li>将各个组件封装为Vue组件，在组件的mounted钩子中加载，beforeUnmount钩子中销毁</li>
                        <li>使用Vuex或Composition API管理全局状态和组件间通信</li>
                    </ol>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-800">3. 在Vue 3中的响应式处理</h3>
                    <p class="text-gray-700">在Vue 3中，您可以使用Composition API更优雅地处理组件生命周期和事件监听：</p>
                    <pre class="bg-gray-100 p-3 rounded-md overflow-x-auto mt-2"><code>// 使用Vue 3 Composition API
import { onMounted, onUnmounted, ref, watch } from 'vue'

export default {
  setup(props) {
    const status = ref('未初始化')
    
    // 监听props变化
    watch(() => props.waylineId, (newId) => {
      if (newId && window.FH2) {
        window.FH2.loadWayline("wayline-app-container", { wayline_id: newId });
      }
    })
    
    // 组件挂载
    onMounted(() => {
      if (window.FH2 && props.waylineId) {
        window.FH2.loadWayline("wayline-app-container", { wayline_id: props.waylineId });
        status.value = '已加载'
        
        // 事件订阅
        window.FH2.subscribe('wayline-save', () => {
          status.value = '航线保存成功'
        })
      }
    })
    
    // 组件卸载
    onUnmounted(() => {
      if (window.FH2) {
        window.FH2.destroyWayline()
      }
    })
    
    return {
      status
    }
  }
}</code></pre>
                </div>
                
                <div>
                    <h3 class="text-lg font-medium text-gray-800">4. 注意事项</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                        <li>确保在加载组件前，FH2 SDK已正确初始化</li>
                        <li>组件容器的ID在页面中必须唯一</li>
                        <li>在Vue组件销毁时，务必调用相应的destroy方法释放资源</li>
                        <li>对于SPA应用，需要注意路由切换时的组件卸载和重新加载逻辑</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 创建Vue应用实例
        const { createApp, ref, reactive } = Vue
        
        const app = createApp({
            setup() {
                // 响应式数据
                const isInitialized = ref(false)
                const isDarkTheme = ref(false)
                const statusMessage = ref('')
                const statusError = ref(false)
                
                // 服务器配置
                const serverConfig = reactive({
                    ip: '127.0.0.1',
                    projectId: '',
                    token: ''
                })
                
                // 组件配置
                const componentConfig = reactive({
                    gatewaySn: '',
                    droneSn: '',
                    waylineId: ''
                })
                
                // 更新状态信息
                const updateStatus = (message, isErrorMsg = false) => {
                    statusMessage.value = message
                    statusError.value = isErrorMsg
                    console.log(`[FH2 Vue Demo] ${message}`)
                    
                    // 3秒后清除非错误状态信息
                    if (!isErrorMsg) {
                        setTimeout(() => {
                            if (statusMessage.value === message) {
                                statusMessage.value = ''
                            }
                        }, 3000)
                    }
                }
                
                // 初始化系统
                const initSystem = () => {
                    try {
                        window.FH2.initConfig({
                            serverUrl: `http://${serverConfig.ip}:30812`,
                            wssUrl: `ws://${serverConfig.ip}:30812/duplex/web`,
                            hostUrl: `http://${serverConfig.ip}`,
                            prjId: serverConfig.projectId,
                            projectToken: serverConfig.token
                        });
                        
                        isInitialized.value = true
                        updateStatus('系统初始化成功')
                        
                        // 订阅地图加载事件
                        window.FH2.subscribe('cesium-viewer-change', (key) => {
                            updateStatus(`地图实例加载: ${key}`)
                        })
                        
                        // 订阅航线相关事件
                        window.FH2.subscribe('wayline-cancel', () => {
                            updateStatus('取消保存航线')
                        })
                        window.FH2.subscribe('wayline-save', () => {
                            updateStatus('保存航线成功')
                        })
                        window.FH2.subscribe('wayline-back', () => {
                            updateStatus('退出航线编辑器')
                        })
                        
                        // 订阅航线创建相关事件
                        window.FH2.subscribe('wayline-creation-saved', (id) => {
                            updateStatus(`创建航线成功，ID: ${id}`)
                            componentConfig.waylineId = id // 自动填充新创建的航线ID
                        })
                        window.FH2.subscribe('wayline-creation-cancel', () => {
                            updateStatus('取消创建航线')
                        })
                        
                    } catch (error) {
                        updateStatus(`初始化失败: ${error.message}`, true)
                        isInitialized.value = false
                    }
                }
                
                // 加载所有组件
                const loadAllComponents = () => {
                    if (!isInitialized.value) {
                        updateStatus('请先初始化系统', true)
                        return
                    }
                    
                    try {
                        // 加载项目地图
                        window.FH2.loadProject("project-app-container")
                        updateStatus('加载项目地图组件')
                        
                        // 加载驾驶舱
                        window.FH2.loadCockpit("cockpit-app-container", {
                            gateway_sn: componentConfig.gatewaySn || "",
                            drone_sn: componentConfig.droneSn || ""
                        })
                        updateStatus('加载驾驶舱组件')
                        
                        // 加载航线编辑器
                        window.FH2.loadWayline("wayline-app-container", {
                            wayline_id: componentConfig.waylineId || ""
                        })
                        updateStatus('加载航线编辑器组件')
                        
                        // 加载航线创建组件
                        window.FH2.loadWaylineCreation("wayline-create-app-container")
                        updateStatus('加载航线创建组件')
                        
                    } catch (error) {
                        updateStatus(`加载组件失败: ${error.message}`, true)
                    }
                }
                
                // 销毁所有组件
                const destroyAllComponents = () => {
                    try {
                        // 销毁各个组件
                        if (window.FH2) {
                            window.FH2.destroyProject()
                            window.FH2.destroyCockpit()
                            window.FH2.destroyWayline()
                            window.FH2.destroyWaylineCreation()
                        }
                        updateStatus('所有组件已销毁')
                    } catch (error) {
                        updateStatus(`销毁组件失败: ${error.message}`, true)
                    }
                }
                
                // 切换主题
                const toggleTheme = () => {
                    isDarkTheme.value = !isDarkTheme.value
                    document.body.className = isDarkTheme.value ? 'set-change-color' : ''
                    updateStatus(isDarkTheme.value ? '已切换到深色主题' : '已切换到默认主题')
                }
                
                // 添加地图自定义元素
                const addCustomMapData = () => {
                    if (!window.FH2 || !window.FH2.cesiumViewer) {
                        updateStatus('地图实例未加载', true)
                        return
                    }
                    
                    try {
                        for (const key in window.FH2.cesiumViewer) {
                            if (Object.prototype.hasOwnProperty.call(window.FH2.cesiumViewer, key)) {
                                window.FH2.cesiumViewer[key].entities.add({
                                    position: window.Cesium.Cartesian3.fromDegrees(113.93, 22.57, 50),
                                    label: {
                                        text: "Vue自定义地图标记",
                                        font: '14pt monospace',
                                        fillColor: Cesium.Color.YELLOW,
                                        outlineColor: Cesium.Color.BLACK,
                                        outlineWidth: 2,
                                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                        pixelOffset: new Cesium.Cartesian2(0, -20),
                                        eyeOffset: new Cesium.Cartesian3(0, 0, 0),
                                        horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM
                                    },
                                    point: {
                                        pixelSize: 10,
                                        color: Cesium.Color.RED,
                                        outlineWidth: 2,
                                        outlineColor: Cesium.Color.WHITE
                                    }
                                })
                            }
                        }
                        updateStatus('已添加自定义地图元素')
                    } catch (error) {
                        updateStatus(`添加地图元素失败: ${error.message}`, true)
                    }
                }
                
                // 单独加载项目地图组件
                const loadProjectComponent = () => {
                    if (!isInitialized.value) {
                        updateStatus('请先初始化系统', true)
                        return
                    }
                    
                    try {
                        window.FH2.loadProject("project-app-container")
                        updateStatus('加载项目地图组件')
                    } catch (error) {
                        updateStatus(`加载项目地图失败: ${error.message}`, true)
                    }
                }
                
                // 销毁项目地图组件
                const destroyProjectComponent = () => {
                    try {
                        if (window.FH2) {
                            window.FH2.destroyProject()
                        }
                        updateStatus('项目地图组件已销毁')
                    } catch (error) {
                        updateStatus(`销毁项目地图失败: ${error.message}`, true)
                    }
                }
                
                // 加载驾驶舱组件
                const loadCockpitComponent = () => {
                    if (!isInitialized.value) {
                        updateStatus('请先初始化系统', true)
                        return
                    }
                    
                    try {
                        window.FH2.loadCockpit("cockpit-app-container", {
                            gateway_sn: componentConfig.gatewaySn || "",
                            drone_sn: componentConfig.droneSn || ""
                        })
                        updateStatus('加载驾驶舱组件')
                    } catch (error) {
                        updateStatus(`加载驾驶舱失败: ${error.message}`, true)
                    }
                }
                
                // 销毁驾驶舱组件
                const destroyCockpitComponent = () => {
                    try {
                        if (window.FH2) {
                            window.FH2.destroyCockpit()
                        }
                        updateStatus('驾驶舱组件已销毁')
                    } catch (error) {
                        updateStatus(`销毁驾驶舱失败: ${error.message}`, true)
                    }
                }
                
                // 加载航线编辑器组件
                const loadWaylineComponent = () => {
                    if (!isInitialized.value) {
                        updateStatus('请先初始化系统', true)
                        return
                    }
                    
                    try {
                        window.FH2.loadWayline("wayline-app-container", {
                            wayline_id: componentConfig.waylineId || ""
                        })
                        updateStatus('加载航线编辑器组件')
                    } catch (error) {
                        updateStatus(`加载航线编辑器失败: ${error.message}`, true)
                    }
                }
                
                // 销毁航线编辑器组件
                const destroyWaylineComponent = () => {
                    try {
                        if (window.FH2) {
                            window.FH2.destroyWayline()
                        }
                        updateStatus('航线编辑器组件已销毁')
                    } catch (error) {
                        updateStatus(`销毁航线编辑器失败: ${error.message}`, true)
                    }
                }
                
                // 加载航线创建组件
                const loadWaylineCreationComponent = () => {
                    if (!isInitialized.value) {
                        updateStatus('请先初始化系统', true)
                        return
                    }
                    
                    try {
                        window.FH2.loadWaylineCreation("wayline-create-app-container")
                        updateStatus('加载航线创建组件')
                    } catch (error) {
                        updateStatus(`加载航线创建失败: ${error.message}`, true)
                    }
                }
                
                // 销毁航线创建组件
                const destroyWaylineCreationComponent = () => {
                    try {
                        if (window.FH2) {
                            window.FH2.destroyWaylineCreation()
                        }
                        updateStatus('航线创建组件已销毁')
                    } catch (error) {
                        updateStatus(`销毁航线创建失败: ${error.message}`, true)
                    }
                }
                
                // 页面加载完成后检查window.FH2是否可用
                window.addEventListener('load', () => {
                    if (window.FH2) {
                        updateStatus('FH2 SDK 已加载')
                    } else {
                        updateStatus('FH2 SDK 加载失败，请检查网络连接或paas.js路径', true)
                    }
                })
                
                // 暴露数据和方法
                return {
                    isInitialized,
                    isDarkTheme,
                    statusMessage,
                    statusError,
                    serverConfig,
                    componentConfig,
                    initSystem,
                    loadAllComponents,
                    destroyAllComponents,
                    toggleTheme,
                    addCustomMapData,
                    loadProjectComponent,
                    destroyProjectComponent,
                    loadCockpitComponent,
                    destroyCockpitComponent,
                    loadWaylineComponent,
                    destroyWaylineComponent,
                    loadWaylineCreationComponent,
                    destroyWaylineCreationComponent
                }
            }
        })
        
        // 挂载Vue应用
        app.mount('#app')
    </script>
</body>
</html>