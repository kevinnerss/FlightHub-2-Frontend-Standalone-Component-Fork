<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>司空2 所有组件集成演示</title>
    <style>
        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #141b2d;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .control-panel {
            background-color: white;
            padding: 15px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .control-panel button {
            margin: 5px;
            padding: 8px 16px;
            background-color: #4cceac;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .control-panel button:hover {
            background-color: #50dcd8;
        }

        .component-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            height: calc(100vh - 180px);
            overflow: hidden;
        }

        .component-section {
            flex: 1;
            min-width: 400px;
            height: calc(50% - 15px);
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .component-title {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(20, 27, 45, 0.9);
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            z-index: 10;
        }

        .component-content {
            height: 100%;
            width: 100%;
        }

        .fh2-container {
            width: 100%;
            height: 100%;
        }

        #project-app-container>div, #cockpit-app-container>div, #wayline-app-container>div,
        .map-app-container>div {
            width: 100%;
            height: 100%;
        }

        .project-details {
            position: relative;
            width: 100%;
            display: flex;
            flex: 1;
            height: 100%;
            overflow: auto;
        }

        .project-details .right-micro-app {
            position: relative;
            display: flex;
            flex: 1;
            height: 100%;
        }

        .project-details .right-micro-app .maps-micro-app {
            display: flex;
            flex: 1;
            height: 100%;
        }

        .project-details .right-micro-app .map-app-placeholder {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .project-details .right-micro-app .map-app-container {
            height: 100%;
        }

        .project-details .right-micro-app #wayline-app-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* 驾驶舱特有样式 */
        .router-cockpit .project-right {
            position: relative;
            width: 320px;
            height: 100%;
        }

        /* 状态信息 */
        .status-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 300px;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>

    <!-- 引入 paas.js -->
    <script src="http://127.0.0.1/paas.js" fh2></script>
    <!-- 引入自定义样式 -->
    <link href="./custom-style.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>司空2 所有组件集成演示</h1>
    </div>

    <div class="alert alert-warning">
        注意：请在下方控制面板中配置连接信息并初始化系统后再加载组件。默认IP为127.0.0.1，端口为30812。
    </div>

    <div class="control-panel">
        <h3>控制面板</h3>
        <div>
            <label for="serverIp">服务IP: </label>
            <input type="text" id="serverIp" value="127.0.0.1" style="width: 150px; padding: 5px; margin-right: 10px;">
            <label for="projectId">项目ID: </label>
            <input type="text" id="projectId" placeholder="输入项目ID" style="width: 200px; padding: 5px; margin-right: 10px;">
            <label for="projectToken">组织密钥: </label>
            <input type="text" id="projectToken" placeholder="输入组织密钥" style="width: 300px; padding: 5px;">
        </div>
        <div style="margin-top: 10px;">
            <button id="initBtn">初始化系统</button>
            <button id="loadAllBtn">加载所有组件</button>
            <button id="destroyAllBtn">销毁所有组件</button>
            <button id="changeThemeBtn">切换主题</button>
            <button id="addMapDataBtn">添加地图自定义元素</button>
        </div>
    </div>

    <div class="component-container">
        <!-- 项目地图组件 -->
        <div class="component-section">
            <div class="component-title">项目地图</div>
            <div id="project-container" class="component-content">
                <div class="fh2-container">
                    <div class="project-details">
                        <div id="project-app-container"></div>
                        <div id="project-middle-container"></div>
                        <div id="project-right-micro-app" class="right-micro-app">
                            <div class="maps-micro-app">
                                <div id="project-map-app-placeholder" class="map-app-placeholder">
                                    <div id="map-app-global" class="map-app-container"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 驾驶舱组件 -->
        <div class="component-section">
            <div class="component-title">驾驶舱</div>
            <div id="cockpit-container" class="component-content">
                <div class="fh2-container">
                    <div id="cockpit-header-container"></div>
                    <div class="project-details router-cockpit">
                        <div id="project-app-container-cockpit"></div>
                        <div id="project-middle-container-cockpit"></div>
                        <div id="project-right-micro-app-cockpit" class="right-micro-app">
                            <div class="maps-micro-app">
                                <div class="cockpit-left-border-container"></div>
                                <div id="project-map-app-placeholder-cockpit" class="map-app-placeholder">
                                    <div class="cockpit-dock-live-container"></div>
                                    <div id="map-app-global-cockpit" class="map-app-container"></div>
                                    <div class="cockpit-bottom-border-container"></div>
                                </div>
                            </div>
                            <div class="project-right">
                                <div id="cockpit-app-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 航线编辑器组件 -->
        <div class="component-section">
            <div class="component-title">航线编辑器</div>
            <div id="wayline-container" class="component-content">
                <div class="fh2-container">
                    <div id="wayline-header"></div>
                    <div class="project-details">
                        <div id="project-app-container-wayline"></div>
                        <div id="project-middle-container-wayline"></div>
                        <div id="project-right-micro-app-wayline" class="right-micro-app">
                            <div class="maps-micro-app">
                                <div id="project-map-app-placeholder-wayline" class="map-app-placeholder">
                                    <div id="map-app-global-wayline" class="map-app-container"></div>
                                </div>
                            </div>
                            <div id="wayline-app-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 航线创建组件 -->
        <div class="component-section">
            <div class="component-title">航线创建</div>
            <div id="wayline-creation-container" class="component-content">
                <div id="wayline-create-app-container"></div>
            </div>
        </div>
    </div>

    <div class="status-info" id="statusInfo">
        状态: 未初始化
    </div>

    <script>
        // 全局变量
        let isInitialized = false;
        let isThemeChanged = false;

        // DOM 元素
        const serverIpInput = document.getElementById('serverIp');
        const projectIdInput = document.getElementById('projectId');
        const projectTokenInput = document.getElementById('projectToken');
        const initBtn = document.getElementById('initBtn');
        const loadAllBtn = document.getElementById('loadAllBtn');
        const destroyAllBtn = document.getElementById('destroyAllBtn');
        const changeThemeBtn = document.getElementById('changeThemeBtn');
        const addMapDataBtn = document.getElementById('addMapDataBtn');
        const statusInfo = document.getElementById('statusInfo');

        // 初始化系统
        initBtn.addEventListener('click', function() {
            const serverIp = serverIpInput.value || '127.0.0.1';
            const projectId = projectIdInput.value;
            const projectToken = projectTokenInput.value;

            try {
                window.FH2.initConfig({
                    serverUrl: `http://${serverIp}:30812`,
                    wssUrl: `ws://${serverIp}:30812/duplex/web`,
                    hostUrl: `http://${serverIp}`,
                    prjId: projectId,
                    projectToken: projectToken
                });
                
                isInitialized = true;
                updateStatus('系统初始化成功');
                
                // 订阅地图加载事件
                window.FH2.subscribe('cesium-viewer-change', (key) => {
                    updateStatus(`地图实例加载: ${key}`);
                });
                
                // 订阅航线相关事件
                window.FH2.subscribe('wayline-cancel', () => {
                    updateStatus('取消保存航线');
                });
                window.FH2.subscribe('wayline-save', () => {
                    updateStatus('保存航线成功');
                });
                window.FH2.subscribe('wayline-back', () => {
                    updateStatus('退出航线编辑器');
                });
                
                // 订阅航线创建相关事件
                window.FH2.subscribe('wayline-creation-saved', (id) => {
                    updateStatus(`创建航线成功，ID: ${id}`);
                });
                window.FH2.subscribe('wayline-creation-cancel', () => {
                    updateStatus('取消创建航线');
                });
                
            } catch (error) {
                updateStatus(`初始化失败: ${error.message}`, true);
                isInitialized = false;
            }
        });

        // 加载所有组件
        loadAllBtn.addEventListener('click', function() {
            if (!isInitialized) {
                updateStatus('请先初始化系统', true);
                return;
            }
            
            try {
                // 加载项目地图
                window.FH2.loadProject("project-app-container");
                updateStatus('加载项目地图组件');
                
                // 加载驾驶舱（注意：实际使用时需要提供有效的网关SN和飞行器SN）
                window.FH2.loadCockpit("cockpit-app-container", {
                    gateway_sn: "", // 实际使用时请提供有效的网关SN
                    drone_sn: ""     // 实际使用时请提供有效的飞行器SN
                });
                updateStatus('加载驾驶舱组件');
                
                // 加载航线编辑器（注意：实际使用时需要提供有效的航线ID）
                window.FH2.loadWayline("wayline-app-container", {
                    wayline_id: "" // 实际使用时请提供有效的航线ID
                });
                updateStatus('加载航线编辑器组件');
                
                // 加载航线创建组件
                window.FH2.loadWaylineCreation("wayline-create-app-container");
                updateStatus('加载航线创建组件');
                
            } catch (error) {
                updateStatus(`加载组件失败: ${error.message}`, true);
            }
        });

        // 销毁所有组件
        destroyAllBtn.addEventListener('click', function() {
            try {
                // 销毁各个组件
                window.FH2.destroyProject();
                window.FH2.destroyCockpit();
                window.FH2.destroyWayline();
                window.FH2.destroyWaylineCreation();
                
                updateStatus('所有组件已销毁');
            } catch (error) {
                updateStatus(`销毁组件失败: ${error.message}`, true);
            }
        });

        // 切换主题
        changeThemeBtn.addEventListener('click', function() {
            isThemeChanged = !isThemeChanged;
            document.body.className = isThemeChanged ? 'set-change-color' : '';
            updateStatus(isThemeChanged ? '已切换到深色主题' : '已切换到默认主题');
        });

        // 添加地图自定义元素
        addMapDataBtn.addEventListener('click', function() {
            if (!window.FH2 || !window.FH2.cesiumViewer) {
                updateStatus('地图实例未加载', true);
                return;
            }
            
            try {
                for (const key in window.FH2.cesiumViewer) {
                    if (Object.prototype.hasOwnProperty.call(window.FH2.cesiumViewer, key)) {
                        const ins = window.FH2.cesiumViewer[key].entities.add({
                            position: window.Cesium.Cartesian3.fromDegrees(113.93, 22.57, 50),
                            label: {
                                text: "自定义地图标记",
                                font: '14pt monospace',
                                fillColor: Cesium.Color.YELLOW,
                                outlineColor: Cesium.Color.BLACK,
                                outlineWidth: 2,
                                style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                                pixelOffset: new Cesium.Cartesian2(0, -20),
                                eyeOffset: new Cesium.Cartesian3(0, 0, 0),
                                horizontalOrigin: Cesium.HorizontalOrigin.CENTER,
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM
                            },
                            point: {
                                pixelSize: 10,
                                color: Cesium.Color.RED,
                                outlineWidth: 2,
                                outlineColor: Cesium.Color.WHITE
                            }
                        });
                    }
                }
                updateStatus('已添加自定义地图元素');
            } catch (error) {
                updateStatus(`添加地图元素失败: ${error.message}`, true);
            }
        });

        // 更新状态信息
        function updateStatus(message, isError = false) {
            statusInfo.textContent = `状态: ${message}`;
            statusInfo.style.backgroundColor = isError ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 0, 0, 0.7)';
            
            console.log(`[FH2 Demo] ${message}`);
        }

        // 页面加载完成后检查window.FH2是否可用
        window.addEventListener('load', function() {
            if (window.FH2) {
                updateStatus('FH2 SDK 已加载');
            } else {
                updateStatus('FH2 SDK 加载失败，请检查网络连接或paas.js路径', true);
            }
        });
    </script>
</body>
</html>